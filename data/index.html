<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP8266 Sensor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .temperature .card-icon {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .humidity .card-icon {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
        }

        .motion .card-icon {
            background: linear-gradient(45deg, #fd79a8, #e84393);
            color: white;
        }

        .luminescence .card-icon {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3436;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .card-unit {
            font-size: 1rem;
            color: #636e72;
            font-weight: 500;
        }

        .motion-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .motion-active {
            background: #00b894;
        }

        .motion-inactive {
            background: #636e72;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }

        .status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9rem;
            color: #636e72;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3436;
        }

        .wifi-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .wifi-connected {
            background: #00b894;
        }

        .wifi-disconnected {
            background: #ff6b6b;
        }

        .mqtt-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .mqtt-connected {
            background: #00b894;
        }

        .mqtt-disconnected {
            background: #ff6b6b;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .card-value {
                font-size: 2rem;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .reset-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reset-btn:hover {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }

        .reset-btn:active {
            transform: scale(0.95);
        }

        .sensor-status {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f8f9fa;
            color: #6c757d;
            font-weight: 500;
        }

        .sensor-status.available {
            background: #d4edda;
            color: #155724;
        }

        .sensor-status.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        .sensor-status.error {
            background: #fff3cd;
            color: #856404;
        }

        .sensorless-status {
            font-size: 14px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            color: #6c757d;
            text-align: center;
            font-weight: 500;
        }

        .sensorless-status.enabled {
            background: #fff3cd;
            color: #856404;
        }

        .motion-badge,
        .radar-badge {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            background: #636e72;
            color: #fff;
            vertical-align: middle;
        }

        .motion-badge.active,
        .radar-badge.active {
            background: #00b894;
        }

        .motion-badge.inactive,
        .radar-badge.inactive {
            background: #636e72;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .config-section {
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #2d3436;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f1f2f6;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .form-group input[type="checkbox"]+label {
            display: inline;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>📊 ESP8266 Sensor Dashboard</h1>
            <p>Real-time monitoring of temperature, humidity, motion, and luminescence</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="dashboard">
            <div class="card temperature">
                <div class="card-header">
                    <div class="card-icon">🌡️</div>
                    <div class="card-title">Temperature</div>
                    <button class="reset-btn" onclick="resetSensor('dht11')" title="Reset DHT11 Sensor">🔄</button>
                </div>
                <div class="card-value" id="temperature">--</div>
                <div class="card-unit">°C</div>
                <div class="sensor-status" id="dht11-status">Status: Unknown</div>
            </div>

            <div class="card humidity">
                <div class="card-header">
                    <div class="card-icon">💧</div>
                    <div class="card-title">Humidity</div>
                    <button class="reset-btn" onclick="resetSensor('dht11')" title="Reset DHT11 Sensor">🔄</button>
                </div>
                <div class="card-value" id="humidity">--</div>
                <div class="card-unit">%</div>
                <div class="sensor-status" id="dht11-status-humidity">Status: Unknown</div>
            </div>

            <div class="card luminescence">
                <div class="card-header">
                    <div class="card-icon">☀️</div>
                    <div class="card-title">Luminescence</div>
                    <button class="reset-btn" onclick="resetSensor('tsl2561')" title="Reset TSL2561 Sensor">🔄</button>
                </div>
                <div class="card-value" id="luminescence">--</div>
                <div class="card-unit">lux</div>
                <div class="sensor-status" id="tsl2561-status">Status: Unknown</div>
            </div>

            <div class="card motion" id="motion-card">
                <div class="card-header">
                    <div class="card-icon">👁️</div>
                    <div class="card-title">Motion Detection</div>
                    <button class="reset-btn" onclick="resetSensor('pir')" title="Reset PIR Sensor">🔄</button>
                </div>
                <div class="card-value">
                    <span class="motion-indicator" id="motion-indicator"></span>
                    <span id="motion-status">No Motion</span>
                    <span id="motion-badge" class="motion-badge inactive">PIR</span>
                </div>
                <div class="card-unit">PIR Sensor</div>
                <div class="sensor-status" id="pir-status">Status: Unknown</div>
            </div>

            <div class="card radar" id="radar-card">
                <div class="card-header">
                    <div class="card-icon">🛰️</div>
                    <div>
                        <div class="card-title">Radar Presence (LD2410)</div>
                    </div>
                </div>
                <div class="card-value" id="radar-value">Loading...
                    <span id="radar-badge" class="radar-badge inactive">Radar</span>
                </div>
                <div class="card-unit" id="radar-source"></div>
            </div>

            <div class="card relay" id="relay-card">
                <div class="card-header">
                    <div class="card-icon">🔌</div>
                    <div class="card-title">Relay Control</div>
                </div>
                <div class="card-value" id="relay-state">--</div>
                <div class="card-unit">Relay Pin: <span id="relay-pin">--</span></div>
                <button class="btn" id="relay-toggle-btn" onclick="toggleRelay()">Toggle Relay</button>
            </div>
        </div>

        <div class="controls">
            <div class="control-card">
                <h3>System Controls</h3>
                <button class="btn" onclick="restartDevice()">🔄 Restart Device</button>
                <button class="btn btn-warning" onclick="resetWiFi()">📶 Reset WiFi Settings</button>
                <button class="btn" onclick="window.open('/update', '_blank')">📤 OTA Update</button>
                <button class="btn" onclick="window.open('/uploadfs', '_blank')">🗂️ Filesystem Update</button>
                <button class="btn" onclick="showConfigModal()">⚙️ Show/Edit Config</button>
            </div>
            <div class="control-card">
                <h3>Sensor Controls</h3>
                <button class="btn btn-warning" onclick="resetAllSensors()">🔄 Reset All Sensors</button>
                <button class="btn" onclick="toggleSensorlessMode()">🔧 Toggle Sensorless Mode</button>
                <button class="btn" id="toggle-motion-source-btn" onclick="toggleMotionSource()">🔄 Toggle Motion
                    Source</button>
                <div class="sensorless-status" id="motion-source-status">Motion Source: ...</div>
            </div>
        </div>

        <div id="firmware-version" style="text-align:center; color:#888; margin-top:20px;">
            Firmware Version: <span id="fw-version-value">...</span>
        </div>

        <!-- Config Modal -->
        <div id="configModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Configuration Editor</h2>
                    <span class="close" onclick="closeConfigModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="config-section">
                        <h3>MQTT Settings</h3>
                        <div class="form-group">
                            <label for="mqtt-broker">MQTT Broker:</label>
                            <input type="text" id="mqtt-broker" placeholder="mqtt.example.com">
                        </div>
                        <div class="form-group">
                            <label for="mqtt-port">MQTT Port:</label>
                            <input type="number" id="mqtt-port" placeholder="1883">
                        </div>
                        <div class="form-group">
                            <label for="mqtt-username">MQTT Username:</label>
                            <input type="text" id="mqtt-username" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label for="mqtt-password">MQTT Password:</label>
                            <input type="password" id="mqtt-password" placeholder="password">
                        </div>
                        <div class="form-group">
                            <label for="mqtt-enabled">MQTT Enabled:</label>
                            <input type="checkbox" id="mqtt-enabled">
                        </div>
                    </div>
                    <div class="config-section">
                        <h3>Device Settings</h3>
                        <div class="form-group">
                            <label for="location">Location:</label>
                            <input type="text" id="location" placeholder="entrance">
                        </div>
                        <div class="form-group">
                            <label for="sensorless-mode">Sensorless Mode:</label>
                            <input type="checkbox" id="sensorless-mode">
                        </div>
                    </div>
                    <div class="config-section">
                        <h3>Sensor Configuration</h3>
                        <div class="form-group">
                            <label for="use-dht">Enable DHT11 (Temperature/Humidity):</label>
                            <input type="checkbox" id="use-dht">
                        </div>
                        <div class="form-group">
                            <label for="use-tsl2561">Enable TSL2561 (Light Sensor):</label>
                            <input type="checkbox" id="use-tsl2561">
                        </div>
                        <div class="form-group">
                            <label for="use-pir">Enable PIR (Motion Sensor):</label>
                            <input type="checkbox" id="use-pir">
                        </div>
                        <div class="form-group">
                            <label for="use-ld2410">Enable LD2410 (Radar Sensor):</label>
                            <input type="checkbox" id="use-ld2410">
                        </div>
                        <div class="form-group">
                            <label for="use-relay">Enable Relay:</label>
                            <input type="checkbox" id="use-relay">
                        </div>
                    </div>
                    <div class="config-section">
                        <h3>Actions</h3>
                        <button class="btn" onclick="saveConfig()">💾 Save Configuration</button>
                        <button class="btn btn-warning" onclick="exportConfig()">📤 Export Config</button>
                        <button class="btn" onclick="printConfig()">🖨️ Print to Serial</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="status">
            <h3>System Status</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">WiFi Status</div>
                    <div class="status-value">
                        <span class="wifi-status" id="wifi-indicator"></span>
                        <span id="wifi-status">Connecting...</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Signal Strength</div>
                    <div class="status-value" id="wifi-rssi">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Free Memory</div>
                    <div class="status-value" id="free-heap">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Uptime</div>
                    <div class="status-value" id="uptime">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">MQTT Status</div>
                    <div class="status-value">
                        <span class="mqtt-status" id="mqtt-indicator"></span>
                        <span id="mqtt-status">--</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Location</div>
                    <div class="status-value" id="location">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;
        let uptimeInterval;
        let configInterval;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function () {
            loadSensorData();
            loadConfigData();
            loadSensorConfig(); // Load sensor configuration to show/hide cards
            updateInterval = setInterval(loadSensorData, 5000); // Update every 5 seconds
            uptimeInterval = setInterval(updateUptime, 1000); // Update uptime every second
            configInterval = setInterval(loadConfigData, 10000); // Update config every 10 seconds
        });

        async function loadSensorData() {
            try {
                console.log('Fetching sensor data...');
                const response = await fetch('/api/sensors');
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received data:', data);
                updateDashboard(data);
                updateRelayCard(data);
                hideError();
                document.getElementById('fw-version-value').textContent = data.firmware_version || 'unknown';
            } catch (error) {
                console.error('Error loading sensor data:', error);
                showError('Failed to load sensor data. Check if the device is connected.');
            }
        }

        function updateDashboard(data) {
            // Update sensor values
            document.getElementById('temperature').textContent = data.temperature ? data.temperature.toFixed(1) : '--';
            document.getElementById('humidity').textContent = data.humidity ? data.humidity.toFixed(1) : '--';
            document.getElementById('luminescence').textContent = data.luminescence || '--';

            // Update motion status
            const motionIndicator = document.getElementById('motion-indicator');
            const motionStatus = document.getElementById('motion-status');

            if (data.motion) {
                motionIndicator.className = 'motion-indicator motion-active';
                motionStatus.textContent = 'Motion Detected!';
            } else {
                motionIndicator.className = 'motion-indicator motion-inactive';
                motionStatus.textContent = 'No Motion';
            }

            // Update sensor status indicators
            updateSensorStatus('dht11', data.dht11_available, data.dht11_errors);
            updateSensorStatus('tsl2561', data.tsl2561_available, data.tsl2561_errors);
            updateSensorStatus('pir', data.pir_available, data.pir_errors);

            // Update system status
            document.getElementById('wifi-rssi').textContent = data.wifi_rssi ? `${data.wifi_rssi} dBm` : '--';
            document.getElementById('free-heap').textContent = data.free_heap ? `${Math.round(data.free_heap / 1024)} KB` : '--';

            // Update WiFi status
            const wifiIndicator = document.getElementById('wifi-indicator');
            const wifiStatus = document.getElementById('wifi-status');

            if (data.wifi_rssi && data.wifi_rssi > -80) {
                wifiIndicator.className = 'wifi-status wifi-connected';
                wifiStatus.textContent = 'Connected';
            } else {
                wifiIndicator.className = 'wifi-status wifi-disconnected';
                wifiStatus.textContent = 'Weak/Disconnected';
            }

            // Update MQTT status
            const mqttIndicator = document.getElementById('mqtt-indicator');
            const mqttStatus = document.getElementById('mqtt-status');

            if (data.mqtt_connected) {
                mqttIndicator.className = 'mqtt-status mqtt-connected';
                mqttStatus.textContent = 'Connected';
            } else {
                mqttIndicator.className = 'mqtt-status mqtt-disconnected';
                mqttStatus.textContent = 'Disconnected';
            }

            // Store timestamp for uptime calculation
            if (data.timestamp) {
                window.deviceStartTime = Date.now() - data.timestamp;
            }

            // Update location if available
            if (data.location) {
                document.getElementById('location').textContent = data.location;
            }

            // Update sensorless mode status
            updateSensorlessStatus(data.sensorless_mode);

            // Radar presence
            const radarValue = document.getElementById('radar-value');
            const radarSource = document.getElementById('radar-source');
            if (radarValue && radarSource) {
                radarValue.textContent = data.radar_presence ? "Presence detected" : "No presence";
                radarValue.style.color = data.radar_presence ? "#00b894" : "#636e72";
                radarSource.textContent = data.motion_source === "radar" ? "Active" : "Inactive";
                radarSource.style.color = data.motion_source === "radar" ? "#00b894" : "#636e72";
            }

            // Motion and Radar badges
            const motionBadge = document.getElementById('motion-badge');
            const radarBadge = document.getElementById('radar-badge');
            if (motionBadge && radarBadge) {
                if (data.motion_source === "pir") {
                    motionBadge.className = "motion-badge active";
                    radarBadge.className = "radar-badge inactive";
                } else {
                    motionBadge.className = "motion-badge inactive";
                    radarBadge.className = "radar-badge active";
                }
            }

            // Show/hide motion and radar cards based on config
            const motionCard = document.getElementById('motion-card');
            const radarCard = document.getElementById('radar-card');
            if (data.sensorless_mode) {
                if (motionCard) motionCard.style.display = "none";
                if (radarCard) radarCard.style.display = "none";
            } else if (data.motion_source === "pir") {
                if (motionCard) motionCard.style.display = "";
                if (radarCard) radarCard.style.display = "none";
            } else {
                if (motionCard) motionCard.style.display = "none";
                if (radarCard) radarCard.style.display = "";
            }
        }

        function updateUptime() {
            if (window.deviceStartTime) {
                const uptime = Date.now() - window.deviceStartTime;
                const hours = Math.floor(uptime / 3600000);
                const minutes = Math.floor((uptime % 3600000) / 60000);
                const seconds = Math.floor((uptime % 60000) / 1000);
                document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
            }
        }

        async function restartDevice() {
            if (confirm('Are you sure you want to restart the device?')) {
                try {
                    const response = await fetch('/api/restart', { method: 'POST' });
                    if (response.ok) {
                        alert('Device is restarting...');
                        setTimeout(() => {
                            window.location.reload();
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Error restarting device:', error);
                    showError('Failed to restart device.');
                }
            }
        }

        async function resetWiFi() {
            if (confirm('Are you sure you want to reset WiFi settings? The device will restart and create a hotspot.')) {
                try {
                    const response = await fetch('/api/wifi/reset', { method: 'POST' });
                    if (response.ok) {
                        alert('WiFi settings reset. Device will restart and create hotspot "ESP8266_Sensor_Network"');
                        setTimeout(() => {
                            window.location.reload();
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Error resetting WiFi:', error);
                    showError('Failed to reset WiFi settings.');
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function updateSensorStatus(sensorType, available, errors) {
            const statusElement = document.getElementById(`${sensorType}-status`);
            const statusElementHumidity = document.getElementById(`${sensorType}-status-humidity`);

            if (statusElement) {
                if (available) {
                    statusElement.textContent = `Status: Available (${errors} errors)`;
                    statusElement.className = 'sensor-status available';
                } else {
                    statusElement.textContent = `Status: Not Available (${errors} errors)`;
                    statusElement.className = 'sensor-status unavailable';
                }
            }

            // Update humidity status separately (same sensor as temperature)
            if (sensorType === 'dht11' && statusElementHumidity) {
                if (available) {
                    statusElementHumidity.textContent = `Status: Available (${errors} errors)`;
                    statusElementHumidity.className = 'sensor-status available';
                } else {
                    statusElementHumidity.textContent = `Status: Not Available (${errors} errors)`;
                    statusElementHumidity.className = 'sensor-status unavailable';
                }
            }
        }

        async function resetSensor(sensorType) {
            const sensorNames = {
                'dht11': 'DHT11 (Temperature & Humidity)',
                'tsl2561': 'TSL2561 (Light Sensor)',
                'pir': 'PIR (Motion Sensor)'
            };

            const sensorName = sensorNames[sensorType] || sensorType;

            if (confirm(`Are you sure you want to reset the ${sensorName}?`)) {
                try {
                    const response = await fetch(`/api/sensors/${sensorType}/reset`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showSuccess(`${sensorName} reset successfully!`);

                        // Refresh sensor data immediately
                        setTimeout(() => {
                            loadSensorData();
                        }, 1000);
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error resetting sensor:', error);
                    showError(`Failed to reset ${sensorName}. Please try again.`);
                }
            }
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#00b894';

            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        async function resetAllSensors() {
            if (confirm('Are you sure you want to reset all sensors? This will mark all sensors as available.')) {
                try {
                    const response = await fetch('/api/sensors/reset', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showSuccess('All sensors reset successfully!');

                        // Refresh sensor data immediately
                        setTimeout(() => {
                            loadSensorData();
                        }, 1000);
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error resetting all sensors:', error);
                    showError('Failed to reset all sensors. Please try again.');
                }
            }
        }

        async function toggleSensorlessMode() {
            try {
                // First get current sensor data to determine current mode
                const response = await fetch('/api/sensors');
                const data = await response.json();
                const currentMode = data.sensorless_mode;
                const newMode = !currentMode;

                const modeText = newMode ? 'enable' : 'disable';
                if (confirm(`Are you sure you want to ${modeText} sensorless mode?`)) {
                    const toggleResponse = await fetch('/api/sensorless', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ enabled: newMode })
                    });

                    if (toggleResponse.ok) {
                        const result = await toggleResponse.json();
                        showSuccess(`Sensorless mode ${newMode ? 'enabled' : 'disabled'} successfully!`);

                        // Refresh sensor data immediately
                        setTimeout(() => {
                            loadSensorData();
                        }, 1000);
                    } else {
                        throw new Error(`HTTP error! status: ${toggleResponse.status}`);
                    }
                }
            } catch (error) {
                console.error('Error toggling sensorless mode:', error);
                showError('Failed to toggle sensorless mode. Please try again.');
            }
        }

        function updateSensorlessStatus(enabled) {
            const statusElement = document.getElementById('sensorless-status');
            if (statusElement) {
                statusElement.textContent = `Sensorless Mode: ${enabled ? 'Enabled' : 'Disabled'}`;
                statusElement.className = enabled ? 'sensorless-status enabled' : 'sensorless-status';
            }
        }

        async function toggleMotionSource() {
            try {
                // Get current config to determine current mode
                const response = await fetch('/api/config');
                const config = await response.json();
                const currentMode = config.use_ld2410;
                const newMode = !currentMode;

                const modeText = newMode ? 'Radar (LD2410)' : 'PIR';
                if (confirm(`Are you sure you want to switch motion source to ${modeText}?`)) {
                    const toggleResponse = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            use_ld2410: newMode,
                            use_pir: !newMode  // Disable the other motion sensor
                        })
                    });

                    if (toggleResponse.ok) {
                        showSuccess(`Motion source switched to ${modeText}!`);
                        setTimeout(() => {
                            loadSensorData();
                            loadConfigData();
                        }, 1000);
                    } else {
                        throw new Error(`HTTP error! status: ${toggleResponse.status}`);
                    }
                }
            } catch (error) {
                console.error('Error toggling motion source:', error);
                showError('Failed to toggle motion source. Please try again.');
            }
        }

        // Update the status display
        function updateMotionSourceStatus(motionSource) {
            const statusElement = document.getElementById('motion-source-status');
            if (statusElement) {
                const sourceText = motionSource === "radar" ? "Radar (LD2410)" :
                    motionSource === "pir" ? "PIR" : "None";
                statusElement.textContent = `Motion Source: ${sourceText}`;
            }
        }

        async function loadConfigData() {
            try {
                console.log('Fetching config data...');
                const response = await fetch('/api/config');
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received data:', data);
                updateSystemStatus(data); // <-- fixed typo
                hideError();
            } catch (error) {
                console.error('Error loading config data:', error);
                showError('Failed to load config data. Check if system is running.');
            }
        }

        async function loadSensorConfig() {
            try {
                const response = await fetch('/api/sensor-config');
                if (response.ok) {
                    const sensorConfig = await response.json();
                    updateCardVisibility(sensorConfig);
                }
            } catch (error) {
                console.error('Error loading sensor config:', error);
            }
        }

        function updateCardVisibility(sensorConfig) {
            // Temperature/Humidity card (DHT11)
            const temperatureCard = document.querySelector('.temperature');
            const humidityCard = document.querySelector('.humidity');
            if (temperatureCard && humidityCard) {
                if (sensorConfig.use_dht) {
                    temperatureCard.style.display = '';
                    humidityCard.style.display = '';
                } else {
                    temperatureCard.style.display = 'none';
                    humidityCard.style.display = 'none';
                }
            }

            // Luminescence card (TSL2561)
            const luminescenceCard = document.querySelector('.luminescence');
            if (luminescenceCard) {
                luminescenceCard.style.display = sensorConfig.use_tsl2561 ? '' : 'none';
            }

            // Motion card (PIR)
            const motionCard = document.getElementById('motion-card');
            if (motionCard) {
                motionCard.style.display = sensorConfig.use_pir ? '' : 'none';
            }

            // Radar card (LD2410)
            const radarCard = document.getElementById('radar-card');
            if (radarCard) {
                radarCard.style.display = sensorConfig.use_ld2410 ? '' : 'none';
            }

            // Relay card
            const relayCard = document.getElementById('relay-card');
            if (relayCard) {
                relayCard.style.display = sensorConfig.use_relay ? '' : 'none';
            }
        }

        function updateSystemStatus(config) { // <-- fixed typo
            const mqttStatus = document.getElementById('mqttStatus');
            if (mqttStatus) mqttStatus.textContent = config.mqtt_connected ? "Connected" : "Disconnected";
            const mqttBroker = document.getElementById('mqttBroker');
            if (mqttBroker) mqttBroker.textContent = config.mqtt_broker + ":" + config.mqtt_port;
            const location = document.getElementById('location');
            if (location) location.textContent = config.location;

            // Update motion source status based on which sensors are enabled
            const motionSource = config.use_ld2410 ? "radar" : (config.use_pir ? "pir" : "none");
            updateMotionSourceStatus(motionSource);
        }

        function updateRelayCard(data) {
            const relayState = document.getElementById('relay-state');
            const relayPin = document.getElementById('relay-pin');
            const relayBtn = document.getElementById('relay-toggle-btn');
            if (relayState && relayPin && relayBtn) {
                relayState.textContent = data.relay_state ? 'ON' : 'OFF';
                relayState.style.color = data.relay_state ? '#00b894' : '#636e72';
                relayPin.textContent = data.relay_pin;
                relayBtn.textContent = data.relay_state ? 'Turn OFF' : 'Turn ON';
            }
        }

        async function toggleRelay() {
            try {
                // Get current state
                const relayStateElem = document.getElementById('relay-state');
                const currentState = relayStateElem && relayStateElem.textContent === 'ON';
                const newState = !currentState;
                const response = await fetch('/api/relay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state: newState })
                });
                if (response.ok) {
                    const result = await response.json();
                    loadSensorData(); // Refresh state
                } else {
                    showError('Failed to toggle relay.');
                }
            } catch (error) {
                showError('Failed to toggle relay.');
            }
        }

        // Handle page visibility changes to pause updates when tab is not visible
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                clearInterval(updateInterval);
                clearInterval(uptimeInterval);
                clearInterval(configInterval);
            } else {
                loadSensorData();
                updateInterval = setInterval(loadSensorData, 5000);
                uptimeInterval = setInterval(updateUptime, 1000);
                configInterval = setInterval(loadConfigData, 10000);
                loadConfigData(); // Also refresh config when tab becomes visible
            }
        });

        // Config Modal Functions
        async function showConfigModal() {
            try {
                // Load current configuration from API
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const config = await response.json();

                // Populate modal with current config
                document.getElementById('mqtt-broker').value = config.mqtt_broker || '';
                document.getElementById('mqtt-port').value = config.mqtt_port || 1883;
                document.getElementById('mqtt-username').value = config.mqtt_username || '';
                document.getElementById('mqtt-password').value = config.mqtt_password || '';
                document.getElementById('mqtt-enabled').checked = config.mqtt_enabled || false;
                document.getElementById('location').value = config.location || '';
                document.getElementById('sensorless-mode').checked = config.sensorless_mode || false;
                document.getElementById('use-dht').checked = config.use_dht || false;
                document.getElementById('use-tsl2561').checked = config.use_tsl2561 || false;
                document.getElementById('use-pir').checked = config.use_pir || false;
                document.getElementById('use-ld2410').checked = config.use_ld2410 || false;
                document.getElementById('use-relay').checked = config.use_relay || false;

                // Show the modal
                document.getElementById('configModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading configuration:', error);
                showError('Failed to load configuration. Please try again.');
            }
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        async function saveConfig() {
            const mqttBroker = document.getElementById('mqtt-broker').value;
            const mqttPort = document.getElementById('mqtt-port').value;
            const mqttUsername = document.getElementById('mqtt-username').value;
            const mqttPassword = document.getElementById('mqtt-password').value;
            const mqttEnabled = document.getElementById('mqtt-enabled').checked;
            const location = document.getElementById('location').value;
            const sensorlessMode = document.getElementById('sensorless-mode').checked;
            const useDht = document.getElementById('use-dht').checked;
            const useTsl2561 = document.getElementById('use-tsl2561').checked;
            const usePir = document.getElementById('use-pir').checked;
            const useLd2410 = document.getElementById('use-ld2410').checked;
            const useRelay = document.getElementById('use-relay').checked;

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mqtt_broker: mqttBroker,
                        mqtt_port: mqttPort,
                        mqtt_username: mqttUsername,
                        mqtt_password: mqttPassword,
                        mqtt_enabled: mqttEnabled,
                        location: location,
                        sensorless_mode: sensorlessMode,
                        use_dht: useDht,
                        use_tsl2561: useTsl2561,
                        use_pir: usePir,
                        use_ld2410: useLd2410,
                        use_relay: useRelay
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Configuration saved successfully!');
                    loadConfigData(); // Refresh config display

                    // Close the modal
                    closeConfigModal();

                    // Ask user if they want to restart
                    if (confirm('Configuration saved! Some changes may require a device restart to take effect. Would you like to restart the device now?')) {
                        restartDevice();
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showError('Failed to save configuration. Please try again.');
            }
        }

        async function exportConfig() {
            try {
                const response = await fetch('/api/config/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'sensor_config.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showSuccess('Configuration exported successfully!');
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error exporting config:', error);
                showError('Failed to export configuration. Please try again.');
            }
        }

        async function printConfig() {
            try {
                const response = await fetch('/api/config/print');
                if (response.ok) {
                    const text = await response.text();
                    alert('Configuration printed to serial:\n' + text);
                    showSuccess('Configuration printed to serial!');
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error printing config:', error);
                showError('Failed to print configuration to serial. Please try again.');
            }
        }
    </script>
</body>

</html>